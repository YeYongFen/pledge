{"version":3,"file":"promise.js","sources":["../src/promise/error.js","../src/promise/utils.js","../src/promise/asap.js","../src/promise/promise.js","../src/index.js"],"sourcesContent":["const constructorErrorText = 'Failed to construct \\'Promise\\': Please use the \\'new\\' operator, this object constructor cannot be called as a function.';\r\nconst resolverErrorText = 'You must pass a resolver function as the first argument to the promise constructor';\r\nconst resolveSelfErrorText = 'You cannot resolve a promise with itself';\r\nconst cannotReturnOwnText = 'A promises callback cannot return that same promise.';\r\nconst validationErrorText = 'Array Methods must be provided an Array';\r\nconst needsResolverText = 'You must pass a resolver function as the first argument to the promise constructor';\r\n\r\nexport const constructorError = () => new TypeError(constructorErrorText);\r\n\r\nexport const resolverError = () => new TypeError(resolverErrorText);\r\n\r\nexport const resolveSelfError = () => new TypeError(resolveSelfErrorText);\r\n\r\nexport const cannotReturnOwn = () => new TypeError(cannotReturnOwnText);\r\n\r\nexport const validationError = () => new Error(validationErrorText);\r\n\r\nexport const needsResolver = () => new TypeError(needsResolverText);\r\n","export const isObject = (val) => {\r\n  return val !== null && typeof val === 'object';\r\n};\r\n\r\nexport const isFunction = (val) => {\r\n  return toString.call(val) === '[object Function]';\r\n};\r\n\r\nexport const noop = () => {}\r\n;\r\n","\r\nlet queue = [];\r\nlet index = 0;\r\n// let flushing = false;\r\nlet capacity = 1024;\r\n\r\nconst browserWindow = (typeof window !== 'undefined') ? window : undefined;\r\nconst browserGlobal = browserWindow || {};\r\nconst BrowserMutationObserver = browserGlobal.MutationObserver || browserGlobal.WebKitMutationObserver;\r\n\r\nconst requestFlush = (function () {\r\n  if (BrowserMutationObserver) {\r\n    return makeMutationObserver(flush);\r\n  } else {\r\n    return makeMutationTimeout(flush);\r\n  }\r\n})();\r\n\r\nfunction makeMutationObserver (callback) {\r\n  let toggle = 1;\r\n  const observer = new BrowserMutationObserver(callback);\r\n  const node = document.createTextNode('');\r\n  observer.observe(node, { characterData: true, });\r\n  return () => {\r\n    node.data = --toggle;\r\n  };\r\n};\r\n\r\nfunction makeMutationTimeout (callback) {\r\n  return () => setTimeout(callback, 1);\r\n};\r\n\r\nfunction flush () {\r\n  while (index < queue.length) {\r\n    let currentIndex = index;\r\n    index = index + 1;\r\n    queue[currentIndex].call();\r\n\r\n    if (index > capacity) {\r\n      for (let scan = 0, newLength = queue.length - index; scan < newLength; scan++) {\r\n        queue[scan] = queue[scan + index];\r\n      }\r\n      queue.length -= index;\r\n      index = 0;\r\n    }\r\n  }\r\n  queue.length = 0;\r\n  index = 0;\r\n  // flushing = false;\r\n}\r\n\r\nexport default function asap (task) {\r\n  if (!queue.length) {\r\n    requestFlush();\r\n    // flushing = true;\r\n  }\r\n  // Equivalent to push, but avoids a function call.\r\n  queue[queue.length] = task;\r\n}\r\n","\r\nimport { resolverError, constructorError, resolveSelfError, cannotReturnOwn } from './error';\r\nimport { isObject, isFunction, noop } from './utils';\r\nimport asap from './asap';\r\n\r\nconst PENDING = void 0; // undefined\r\nconst FULFILLED = 1;\r\nconst REJECTED = 2;\r\n\r\nlet id = 0;\r\nexport default function Promise (resolver) {\r\n  if (!(this instanceof Promise)) {\r\n    throw constructorError();\r\n  }\r\n  if (typeof resolver !== 'function') {\r\n    throw resolverError();\r\n  }\r\n\r\n  this['[[PromiseStatus]]'] = PENDING;\r\n  this['[[PromiseValue]]'] = undefined;\r\n  this.subscribes = [];\r\n  this.tid = id++;\r\n\r\n  this.initializePromise(resolver);\r\n}\r\n\r\nPromise.prototype.initializePromise = function (resolver) {\r\n  try {\r\n    resolver(\r\n      value => {\r\n        mockResolve(this, value);\r\n      },\r\n      reason => {\r\n        mockReject(this, reason);\r\n      }\r\n    );\r\n  } catch (e) {\r\n    mockReject(this, e);\r\n  }\r\n  return null;\r\n};\r\n\r\nPromise.prototype.fulfill = function (value) {\r\n  if (this['[[PromiseStatus]]'] !== PENDING) {\r\n    return;\r\n  }\r\n  this['[[PromiseStatus]]'] = FULFILLED;\r\n  this['[[PromiseValue]]'] = value;\r\n\r\n  if (this.subscribes.length !== 0) {\r\n    asap(this.publish.bind(this)); // 2.2.4  onFulfilled or onRejected must not be called until the execution context stack contains only platform code.\r\n  }\r\n};\r\n\r\nPromise.prototype.publish = function () {\r\n  const subscribes = this.subscribes;\r\n  const settled = this['[[PromiseStatus]]'];\r\n  const result = this['[[PromiseValue]]'];\r\n  if (subscribes.length === 0) {\r\n    return;\r\n  }\r\n  for (let i = 0; i < subscribes.length; i += 3) {\r\n    const item = subscribes[i];\r\n    const callback = subscribes[i + settled];\r\n    if (item) {\r\n      // this.invokeCallback(state, item, callback, result);\r\n    } else {\r\n      // callback(result);\r\n    }\r\n  }\r\n  this.subscribes.length = 0;\r\n};\r\n\r\nPromise.prototype.invokeCallback = function (settled, child, callback, detail) {\r\n  let hasCallback = isFunction(callback);\r\n  let value; let error; let succeeded; let failed;\r\n\r\n  if (child['[[PromiseStatus]]'] !== PENDING) {\r\n    return;\r\n  }\r\n\r\n  if (hasCallback) {\r\n    try {\r\n      value = callback(detail);\r\n      succeeded = true;\r\n    } catch (e) {\r\n      error = { error: e, };\r\n      failed = true;\r\n    }\r\n    /*\r\n        var p = new Promise((r) => r(1))\r\n        var pp = p.then(() => {\r\n            return pp\r\n        })\r\n\r\n        is not allow\r\n    */\r\n    if (child === value) {\r\n      mockReject(child, cannotReturnOwn());\r\n    }\r\n  } else {\r\n    /*\r\n        var p = new Promise( (r)=>r(1) )\r\n          p.then().then(()=>{\r\n        })\r\n        There is empty then()\r\n    */\r\n    value = detail;\r\n    succeeded = true;\r\n  }\r\n\r\n  if (hasCallback) {\r\n    if (succeeded) {\r\n      mockResolve(child, value);\r\n    } else if (failed) {\r\n      mockReject(child, error);\r\n    }\r\n  } else {\r\n    if (settled === 'fulfilled') {\r\n      this.fulfill.call(child, value);\r\n    } else if (settled === 'rejected') {\r\n      mockReject(child, value);\r\n    }\r\n  }\r\n};\r\n\r\nPromise.prototype.then = function (onFulfilled, onRejected) {\r\n  const parent = this;\r\n  const child = new this.constructor(noop);\r\n\r\n  const state = this['[[PromiseStatus]]'];\r\n\r\n  if (state) { // 'pending' Corresponding to   undefined ，'fulfilled' Corresponding to  1，'rejected' Corresponding to  2\r\n\r\n  } else {\r\n    this.subscribe(parent, child, onFulfilled, onRejected);\r\n  }\r\n\r\n  return child;\r\n};\r\n\r\nPromise.prototype.subscribe = function (parent, child, onFulfilled, onRejected) {\r\n  let {\r\n    subscribes,\r\n    subscribes: { length, },\r\n  } = parent;\r\n  subscribes[length] = child;\r\n  subscribes[length + FULFILLED] = onFulfilled;\r\n  subscribes[length + REJECTED] = onRejected;\r\n  if (length === 0 && parent['[[PromiseStatus]]']) {\r\n    this.asap(this.publish);\r\n  }\r\n};\r\n\r\nfunction mockResolve (promise, value) {\r\n  if (promise === value) {\r\n    mockReject(promise, resolveSelfError()); // 2.3.1、If promise and x refer to the same object, reject promise with a TypeError as the reason\r\n  } else if (isObject(value) || isFunction(value)) { // handle the thenable\r\n    // todo\r\n  } else {\r\n    promise.fulfill(value);\r\n  }\r\n}\r\n\r\nfunction mockReject (promise, value) {\r\n\r\n}\r\n","import Promise from './promise/promise.js';\r\n\r\n// import asap from './promise/asap';\r\n\r\nlet p = new Promise((resolve) => {\r\n  setTimeout(() => {\r\n    resolve(1);\r\n  }, 2222);\r\n}).then((n) => {\r\n  console.log(n);\r\n});\r\n"],"names":["const","let","this"],"mappings":";;;;;;;EAAAA,IAAM,oBAAoB,GAAG,2HAA2H,CAAC;EACzJA,IAAM,iBAAiB,GAAG,oFAAoF,CAAC;AAC/GA;AAKA,EAAOA,IAAM,gBAAgB,eAAM,SAAG,IAAI,SAAS,CAAC,oBAAoB,IAAC,CAAC;;AAE1E,EAAOA,IAAM,aAAa,eAAM,SAAG,IAAI,SAAS,CAAC,iBAAiB,IAAC,CAAC;;ECT7DA,IAAM,QAAQ,aAAI,GAAG,EAAE;IAC5B,OAAO,GAAG,KAAK,IAAI,IAAI,OAAO,GAAG,KAAK,QAAQ,CAAC;GAChD,CAAC;;AAEF,EAAOA,IAAM,UAAU,aAAI,GAAG,EAAE;IAC9B,OAAO,QAAQ,CAAC,IAAI,CAAC,GAAG,CAAC,KAAK,mBAAmB,CAAC;GACnD,CAAC;;AAEF,EAAOA,IAAM,IAAI,eAAM,EAAK;GAC3B;;ECRDC,IAAI,KAAK,GAAG,EAAE,CAAC;EACfA,IAAI,KAAK,GAAG,CAAC,CAAC;;EAEdA,IAAI,QAAQ,GAAG,IAAI,CAAC;;EAEpBD,IAAM,aAAa,GAAG,CAAC,OAAO,MAAM,KAAK,WAAW,IAAI,MAAM,GAAG,SAAS,CAAC;EAC3EA,IAAM,aAAa,GAAG,aAAa,IAAI,EAAE,CAAC;EAC1CA,IAAM,uBAAuB,GAAG,aAAa,CAAC,gBAAgB,IAAI,aAAa,CAAC,sBAAsB,CAAC;;EAEvGA,IAAM,YAAY,GAAG,CAAC,YAAY;IAChC,IAAI,uBAAuB,EAAE;MAC3B,OAAO,oBAAoB,CAAC,KAAK,CAAC,CAAC;KACpC,MAAM;MACL,OAAO,mBAAmB,CAAC,KAAK,CAAC,CAAC;KACnC;GACF,GAAG,CAAC;;EAEL,SAAS,oBAAoB,EAAE,QAAQ,EAAE;IACvCC,IAAI,MAAM,GAAG,CAAC,CAAC;IACfD,IAAM,QAAQ,GAAG,IAAI,uBAAuB,CAAC,QAAQ,CAAC,CAAC;IACvDA,IAAM,IAAI,GAAG,QAAQ,CAAC,cAAc,CAAC,EAAE,CAAC,CAAC;IACzC,QAAQ,CAAC,OAAO,CAAC,IAAI,EAAE,EAAE,aAAa,EAAE,IAAI,GAAG,CAAC,CAAC;IACjD,mBAAU;MACR,IAAI,CAAC,IAAI,GAAG,EAAE,MAAM,CAAC;KACtB,CAAC;GACH;EAED,SAAS,mBAAmB,EAAE,QAAQ,EAAE;IACtC,mBAAU,SAAG,UAAU,CAAC,QAAQ,EAAE,CAAC,IAAC,CAAC;GACtC;EAED,SAAS,KAAK,IAAI;IAChB,OAAO,KAAK,GAAG,KAAK,CAAC,MAAM,EAAE;MAC3BC,IAAI,YAAY,GAAG,KAAK,CAAC;MACzB,KAAK,GAAG,KAAK,GAAG,CAAC,CAAC;MAClB,KAAK,CAAC,YAAY,CAAC,CAAC,IAAI,EAAE,CAAC;;MAE3B,IAAI,KAAK,GAAG,QAAQ,EAAE;QACpB,KAAKA,IAAI,IAAI,GAAG,CAAC,EAAE,SAAS,GAAG,KAAK,CAAC,MAAM,GAAG,KAAK,EAAE,IAAI,GAAG,SAAS,EAAE,IAAI,EAAE,EAAE;UAC7E,KAAK,CAAC,IAAI,CAAC,GAAG,KAAK,CAAC,IAAI,GAAG,KAAK,CAAC,CAAC;SACnC;QACD,KAAK,CAAC,MAAM,IAAI,KAAK,CAAC;QACtB,KAAK,GAAG,CAAC,CAAC;OACX;KACF;IACD,KAAK,CAAC,MAAM,GAAG,CAAC,CAAC;IACjB,KAAK,GAAG,CAAC,CAAC;;GAEX;;AAED,EAAe,SAAS,IAAI,EAAE,IAAI,EAAE;IAClC,IAAI,CAAC,KAAK,CAAC,MAAM,EAAE;MACjB,YAAY,EAAE,CAAC;;KAEhB;;IAED,KAAK,CAAC,KAAK,CAAC,MAAM,CAAC,GAAG,IAAI,CAAC;GAC5B;;ECrDDD,IAAM,OAAO,GAAG,KAAK,CAAC,CAAC;EACvBA,IAAM,SAAS,GAAG,CAAC,CAAC;EACpBA,IAAM,QAAQ,GAAG,CAAC,CAAC;;EAEnBC,IAAI,EAAE,GAAG,CAAC,CAAC;AACX,EAAe,SAAS,OAAO,EAAE,QAAQ,EAAE;IACzC,IAAI,EAAE,IAAI,YAAY,OAAO,CAAC,EAAE;MAC9B,MAAM,gBAAgB,EAAE,CAAC;KAC1B;IACD,IAAI,OAAO,QAAQ,KAAK,UAAU,EAAE;MAClC,MAAM,aAAa,EAAE,CAAC;KACvB;;IAED,IAAI,CAAC,mBAAmB,CAAC,GAAG,OAAO,CAAC;IACpC,IAAI,CAAC,kBAAkB,CAAC,GAAG,SAAS,CAAC;IACrC,IAAI,CAAC,UAAU,GAAG,EAAE,CAAC;IACrB,IAAI,CAAC,GAAG,GAAG,EAAE,EAAE,CAAC;;IAEhB,IAAI,CAAC,iBAAiB,CAAC,QAAQ,CAAC,CAAC;GAClC;;EAED,OAAO,CAAC,SAAS,CAAC,iBAAiB,GAAG,UAAU,QAAQ,EAAE;;;IACxD,IAAI;MACF,QAAQ;kBACN,OAAM;UACJ,WAAW,CAACC,MAAI,EAAE,KAAK,CAAC,CAAC;SAC1B;kBACD,QAAO;SAEN;OACF,CAAC;KACH,CAAC,OAAO,CAAC,EAAE;KAEX;IACD,OAAO,IAAI,CAAC;GACb,CAAC;;EAEF,OAAO,CAAC,SAAS,CAAC,OAAO,GAAG,UAAU,KAAK,EAAE;IAC3C,IAAI,IAAI,CAAC,mBAAmB,CAAC,KAAK,OAAO,EAAE;MACzC,OAAO;KACR;IACD,IAAI,CAAC,mBAAmB,CAAC,GAAG,SAAS,CAAC;IACtC,IAAI,CAAC,kBAAkB,CAAC,GAAG,KAAK,CAAC;;IAEjC,IAAI,IAAI,CAAC,UAAU,CAAC,MAAM,KAAK,CAAC,EAAE;MAChC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;KAC/B;GACF,CAAC;;EAEF,OAAO,CAAC,SAAS,CAAC,OAAO,GAAG,YAAY;IACtCF,IAAM,UAAU,GAAG,IAAI,CAAC,UAAU,CAAC;IACnCA,IAAM,OAAO,GAAG,IAAI,CAAC,mBAAmB,CAAC,CAAC;IAC1CA,IAAM,MAAM,GAAG,IAAI,CAAC,kBAAkB,CAAC,CAAC;IACxC,IAAI,UAAU,CAAC,MAAM,KAAK,CAAC,EAAE;MAC3B,OAAO;KACR;IACD,KAAKC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,UAAU,CAAC,MAAM,EAAE,CAAC,IAAI,CAAC,EAAE;MAC7CD,IAAM,IAAI,GAAG,UAAU,CAAC,CAAC,CAAC,CAAC;MAC3BA,IAAM,QAAQ,GAAG,UAAU,CAAC,CAAC,GAAG,OAAO,CAAC,CAAC;KAM1C;IACD,IAAI,CAAC,UAAU,CAAC,MAAM,GAAG,CAAC,CAAC;GAC5B,CAAC;;EAEF,OAAO,CAAC,SAAS,CAAC,cAAc,GAAG,UAAU,OAAO,EAAE,KAAK,EAAE,QAAQ,EAAE,MAAM,EAAE;IAC7EC,IAAI,WAAW,GAAG,UAAU,CAAC,QAAQ,CAAC,CAAC;IACvCA,IAAI,KAAK,CAAC,AAAW,CAACA,IAAI,SAAS,CAAC;IAEpC,IAAI,KAAK,CAAC,mBAAmB,CAAC,KAAK,OAAO,EAAE;MAC1C,OAAO;KACR;;IAED,IAAI,WAAW,EAAE;MACf,IAAI;QACF,KAAK,GAAG,QAAQ,CAAC,MAAM,CAAC,CAAC;QACzB,SAAS,GAAG,IAAI,CAAC;OAClB,CAAC,OAAO,CAAC,EAAE;OAGX;KAYF,MAAM;;;;;;;MAOL,KAAK,GAAG,MAAM,CAAC;MACf,SAAS,GAAG,IAAI,CAAC;KAClB;;IAED,IAAI,WAAW,EAAE;MACf,IAAI,SAAS,EAAE;QACb,WAAW,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC;OAC3B,AAEA;KACF,MAAM;MACL,IAAI,OAAO,KAAK,WAAW,EAAE;QAC3B,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,KAAK,EAAE,KAAK,CAAC,CAAC;OACjC,AAEA;KACF;GACF,CAAC;;EAEF,OAAO,CAAC,SAAS,CAAC,IAAI,GAAG,UAAU,WAAW,EAAE,UAAU,EAAE;IAC1DD,IAAM,MAAM,GAAG,IAAI,CAAC;IACpBA,IAAM,KAAK,GAAG,IAAI,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;;IAEzCA,IAAM,KAAK,GAAG,IAAI,CAAC,mBAAmB,CAAC,CAAC;;IAExC,IAAI,KAAK,EAAE,CAEV,MAAM;MACL,IAAI,CAAC,SAAS,CAAC,MAAM,EAAE,KAAK,EAAE,WAAW,EAAE,UAAU,CAAC,CAAC;KACxD;;IAED,OAAO,KAAK,CAAC;GACd,CAAC;;EAEF,OAAO,CAAC,SAAS,CAAC,SAAS,GAAG,UAAU,MAAM,EAAE,KAAK,EAAE,WAAW,EAAE,UAAU,EAAE;IAC9E;IAEgB,sCACL;IACX,UAAU,CAAC,MAAM,CAAC,GAAG,KAAK,CAAC;IAC3B,UAAU,CAAC,MAAM,GAAG,SAAS,CAAC,GAAG,WAAW,CAAC;IAC7C,UAAU,CAAC,MAAM,GAAG,QAAQ,CAAC,GAAG,UAAU,CAAC;IAC3C,IAAI,MAAM,KAAK,CAAC,IAAI,MAAM,CAAC,mBAAmB,CAAC,EAAE;MAC/C,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;KACzB;GACF,CAAC;;EAEF,SAAS,WAAW,EAAE,OAAO,EAAE,KAAK,EAAE;IACpC,IAAI,OAAO,KAAK,KAAK,EAAE,CAEtB,MAAM,IAAI,QAAQ,CAAC,KAAK,CAAC,IAAI,UAAU,CAAC,KAAK,CAAC,EAAE,CAEhD,MAAM;MACL,OAAO,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;KACxB;GACF;;;;EC9JDC,IAAI,CAAC,GAAG,IAAI,OAAO,WAAE,OAAO,EAAE;IAC5B,UAAU,aAAI;MACZ,OAAO,CAAC,CAAC,CAAC,CAAC;KACZ,EAAE,IAAI,CAAC,CAAC;GACV,CAAC,CAAC,IAAI,WAAE,CAAC,EAAE;IACV,OAAO,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;GAChB,CAAC,CAAC;;;;"}